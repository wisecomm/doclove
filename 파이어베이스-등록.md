

# 애완동물 사이트
프로젝트명 : doglove (개좋아)

com.softone.doglove

# 앱 실행모듈개발
//- 앱 이름 설정 ( 한글 및 영문 설정 )
//- 앱 아이콘 변경
// - IOS 화면 드래그 막기 
//- 스플래시 화면 제공
 
- 파이어 베이스 테스트
- 파이어 베이스 배포 및 테스트
- 파이어 베이스 : 분석 로그 설정
- 푸시 지원



#######################################
# 파이어 베이스 등록 (AOS)
- 프로젝트 추가 (DocLove) --> 앱 추가 
- google-services.json 다운로드
- 설치 : cordova plugin add cordova-plugin-firebasex

- google-services.json 복사 ( app\src 디렉토리 아래)
- cdv-grade-config.json 파일 "IS_GRADLE_PLUGIN_GOOGLE_SERVICES_ENABLED":true 설정

# Firebase Cloud Messaging API(V1) 사용하기
참조 사이트 : https://velog.io/@thwjd9393/Android-FCM-%EC%A0%84%EC%86%A1-%ED%85%8C%EC%8A%A4%ED%8A%B8with-Postman

# 사이트에서 엑세스 토큰 만듬 : https://developers.google.com/oauthplayground
: 주의 사항 : 키 생성은 전체적으로 영향을 미침 (기존 사용 키 확인필요)
"access_token": "ya29.a0AXooCgvuQzgBTc6THLB_hoA7wbSR0kGYrbLEhF7NF1I2elF81NB6rUU-Dt-0MAGRI5M0tV_lZq5A81iMZC7-PwoVruJ7vizkLLbUsQuwePpIDb71HCLF3mIryx_qEtbXPriQur7f7oB_hQTo9cq4_gPJV4SPNeqS5lg7aCgYKATYSARMSFQHGX2MiLGObzCkZpdpfTmaBd80rZQ0171"

# 포스트 맨 샛팅 : 프로젝트 아이디 확인(oclove-ced06/) 후 사용
https://fcm.googleapis.com/v1/projects/doclove-ced06/messages:send
- 헤드 Application Bearer 에 엑세스 토큰 샛팅


#######################################
# 파이어 베이스 등록 (IOS)
- https://idmsa.apple.com/
Key 등록 : Register a New Key - 이름(apnPushKey), Apple Push Notifications service (APNs) 채크 --> continue  --> Register --> 다운로드 보관)
- 파이어 베이스 iOS 앱 추가 (번들아이디는 애플 사이트에서 확인 - com.softone.doclove)
- 클라우드 메시지 설정에 APN 인증 키 등록 
Key ID : K9N52S56VK
TEAM ID : JUNG IL OH - 5VNT2YZBRT

# Xcode 프로젝트 수정
- GoogleService-Info.plist 업데이터 (프로젝트 안 Resources 딕렉토리)
- Podfile 확인 : 파이어 베이스 추가 되었는지 

- 실행시 시그 6 에러 ( libswiftCore.dylib 로드 에러) 시
Target -> Building Settings -> LD_RUNPATH_SEARCH_PATHS
값변경 : $(inherited)

- 스크리트 추가 후 키확인
- "message": "Firebase In-App Messaging API has not been used in project 에러시
  메시지 다음에 제공되는 URL 로 들어가면 Firebase In-App Messaging API 사용버턴 클릭 


#######################################
function fireBaseInit() {
    var FirebasePlugin;
    FirebasePlugin = window.FirebasePlugin;

    // IOS 만 퍼미션 허용 메시지 발생 (AOS는 항상 그랜트)
    FirebasePlugin.hasPermission(function(hasPermission){
        // Permission to receive notification is NOT granted
        if (!hasPermission) {
            window.FirebasePlugin.grantPermission(function(){
                alert("Permission is granted for iOS");
            }, function(error){
                alert(error);
                alert("grantPermission to get error=" + error);
            });
        }
    });
    
    // IOS - ( 안드로이드 는 없어도  배지가 클리어됨)
    FirebasePlugin.setBadgeNumber(0);

    // 푸시 메시지 받음
    FirebasePlugin.onMessageReceived(function(message) {
        try{
            console.log("===onMessageReceived Start=" + JSON.stringify(message));
            console.log("message.messageType=" + message.messageType);
            // if(window.cordova.platformId === "android") {
            if(message.messageType == "notification"){
                console.log("message.notification_body=" + message.notification_body);
                // andorid 에서 푸시 선택 후 실행시 alert 메시지가 안뜨고 에러
                //                alert("message.notification_body=" + message.notification_body);
            }
        }catch(e){
            console.log("===Exception in onMessageReceived callback: "+e.message);
        }
    }, function(error) {
        console.log("===Failed receiving FirebasePlugin message"+ error);
    });

    // 토큰 리프레시 ( 토큰이 변경될때마다 호출됨 - getToken 같으면 처리 안함)
    FirebasePlugin.onTokenRefresh(function(token){
        console.log("FCM token(refresh)=" + token);
    }, function(error) {
        console.log("Failed to refresh token=" + error);
    });
    // 토큰 받음
    FirebasePlugin.getToken(function(token){
        console.log("===FCM token =" + token);
    }, function(error) {
        console.log("===Failed to get FCM token=" + error);
    });

}



## POST MAN 전송 데이터
{
    "message": {
        // AOS
        "android": {
          "priority": "HIGH",
            "notification": {
              "notification_count": 1
            }
        },
        // IOS
        "apns": {
          "payload": {
            "aps": {
            "badge": 2
            }
          }
        },
        "token": "cNeX610mRuWsJxJ-C8qxKr:APA91bG5tifu2baGh0ddTwAVdrtFVqE_6H_brVUDlDZ6doYNbE9kVy3vgACOCWQE_EQg8Dd5h8PNyhpWyIMclzZH5NTgH40cPpdfOXn4GaKsuhI4FLcYNynnpLTQOmI9za873aNfqeot", 
        "notification": {
          "title": "한글 타이틀 Title of Your Notification in data",
          "body": "한글 바디-2 Body of Your Notification in data"
        },
        "data": {
            "notification_title": "데이터 title1",
            "notification_body": "데이터 body2-2",
            "link" : "",
            "priority" : "high",
            "sound" : "default"
        }
    }
}
